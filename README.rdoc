= capistrano-abril

Defaults and recipes used in our deployments.

Based on 'capistrano-helpers' gem.
    https://github.com/westarete/capistrano-helpers

All deploys are expected to have multistage scenarios.
Some reference:
    http://help.github.com/capistrano/
	http://help.github.com/deploy-keys
    https://github.com/leehambley/capistrano-handbook/blob/master/index.markdown

== Usage

In your capistrano deploy recipe, simply require the helpers that contain the
functionality that you would like to add to your recipe. In most cases this
also takes care of adding the hook so that the action takes place at the right
time during deployment.

Here's an example config/deploy.rb that uses a few helpers:

  require 'capistrano-abril/branch'     # Deploy by BRANCH/TAG/commit
  require 'capistrano-abril/bundler'    # Runs "bundle install" correctly
  require 'capistrano-abril/config'     # Symlink to config file
  require 'capistrano-abril/multistage' # Support to multistage scenarios
  require 'capistrano-abril/passenger'  # Support for Apache passenger
  require 'capistrano-abril/setup'      # deploy:setup as supposed to be.
  require 'capistrano-abril/version'    # Record the version number after deploying

  # Parameters
  set :application , "myapp"
  set :scm         , "git"
  set :repository  , "git@github.com:mycompany/myapp.git"


That's it! The recipe will now also perform the actions described by the
helpers: ask for a branch, call bundle install, use multistage and so on.

== Helpers

=== abril

Defines all deploy variables used to put the app in the expected directory
tree:
	/abd/app/mysite1
	/abd/app/mysite1/config
	/abd/app/mysite1/git-mysite1
	/abd/app/mysite1/current     -> /abd/app/mysite1/releseas/2011-02-01-1015
	/abd/app/mysite1/current/log -> /abd/logs/mysite1
	/abd/app/mysite1/current/tmp
	/abd/app/mysite1/current/tmp/pids -> /abd/logs/mysite1
	/abd/app/mysite1/releases
	/abd/app/mysite1/releases/2011-02-01-1015
	/abd/logs/mysite1
	
=== branch

Sets branch/tag/commit to deploy from the command line:

    $ BRANCH=my-branch-name cap dev deploy   # deploy by branch
    $ TAG=my-tag-name       cap dev deploy   # deploy by tag
    $ TAG=<sha1 commit>     cap dev deploy   # deploy by commit

If not, prompts the user for the particular tag/branch/commit to deploy:

    $ cap dev deploy       # will prompt user


=== bundler

Automatically install gems from your Gemfile at the appropriate time.

In production:
    bundle install --deployment --without test development

Other environments:
	bundle install --deployment


=== config_files

Link all desired config files, local to the deployment server inside
'#{shared_path}/config', to #{latest_release}/config dir.


	### Symlink from #{shared_path}/config to #{latest_release}/config
	###     file(s) => destination
	set :config_files, {
	    '*.yml'          => "config/",
	    'production.rb'  => "config/environments/"
	}

=== gems

Run the gems:install rake task using sudo after deployment.

Tip: is best to use bundler helper.

=== multistage

Define different scenarios (stages) to deploy to. Each stage is a file placed in
config/deploy/ listing the group of servers/roles to deploy to.

Example:

  * File config/deploy/dev.rb (example using 'roles')

        server "192.168.1.101", :db, :app, :web
        role :app, "192.168.1.101"
        role :web, "192.168.1.101"
        role :db , "192.168.1.101", :primary => true

  * File config/deploy/prod.rb (example using 'server')

        server "app-ws01.example.com", :web, :app
        server "app-ws02.example.com", :web, :app
        server "app-db01.example.com", :db , :primary => true
        server "app-db02.example.com", :db


Using:

    # Deploy to development (Multistage 'dev'):
    $ BRANCH=master   cap dev deploy

    # Deploy to production (Multistage 'prod'):
    $ TAG=release-1.0 cap prod deploy


=== migrations

Always run migrations during deployment. Optional.

=== passenger

Overrides the default :restart task so that it's compatible with restarting
apache/passenger (aka mod_rails). Touches tmp/restart.txt.

=== php

Use this helper when using capistrano to deploy a purely PHP application.

All rails specific tasks are not executed.

=== site-reference

Alexandria: deploy this app as a site-reference clone.

An applications must be either of type site-reference or site-structure, not both.

Must be defined:
    set :structure_path = /abd/app/mysite/structure

At the end the following link is created:
	/abd/app/mysite/current/structure -> /abd/app/mysite/structure/current


=== site-structure

Alexandria: deploy this app as a site-structure app, using a directory
structure inside /abd/app/mysite/structure:

	/abd/app/mysite1/structure/
	/abd/app/mysite1/structure/config
	/abd/app/mysite1/structure/git-mysite1-structure
	/abd/app/mysite1/structure/current ->
	/abd/app/mysite1/structure/releases
	/abd/app/mysite1/structure/releases/2011-03-02-1445


=== specs

Before the app is deployed, this helper checks out the branch/tag that is
being deployed and runs all the rspec specs, ensuring that they all pass.

=== symlinks

During deployment, this helper replaces each of the given paths with a
symbolic link that points to files or directories that contain data 
that should persist across deployments (uploads, assets, for example).

After requiring this helper, set the paths to be symlinked using the
:symlinks variable:

	### Symlink inside RAILS_ROOT
	###     path => destination
	set :symlinks, {
	    '/data/libc'       => "public/libc"  ,
	    '/data/tst/assets' => "public/assets",
	    '/data/tst/static' => "public/static",
	}

=== version

Creates a VERSION file in the deployed copy that contains the name of the
branch/tag that was deployed.


== Copyright

Copyright (c) 2011 ????

